# upstreams
upstream gateway
{
	server gateway-service:3003;
}

upstream ws_backend
{
	server ws-service:4000;
}

upstream frontend
{
	server frontend:3000;
}

# handle Upgrade header for websockets
map $http_upgrade $connection_upgrade
{
	default	upgrade;
	''		close;
}

# Redirect HTTP to HTTPS
server
{
	listen 80;
	server_name localhost;
	location /
	{
		return 301 https://$host$request_uri;
	}
}

# HTTPS server
server
{
	listen 443 ssl;
	server_name localhost;

	ssl_certificate		/etc/nginx/certs/server.crt;
	ssl_certificate_key	/etc/nginx/certs/server.key;

	# Public API
	location /api/
	{
		proxy_pass http://gateway/;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection $connection_upgrade;
	}

	# WebSocket
	location /ws/
	{
		proxy_pass http://ws_backend/;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection $connection_upgrade;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
	}

	# Frontend at root
	location /
	{
		proxy_pass http://frontend/;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection $connection_upgrade;
	}
}
